name: Deploy Site

on:
  push:
    branches: [main]
    paths:
      - "site/**"
      - "crates/wasm/**"
      - "crates/core/**"
      - "firebase.json"
      - ".firebaserc"
      - ".github/workflows/deploy-site.yml"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    name: Build & Deploy to Firebase Hosting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Build WASM package
        run: wasm-pack build crates/wasm --target web --out-dir ../../site/public/pkg --no-typescript
        # outputs into site/public/pkg/ so Vite can serve it as a static asset

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: site/package-lock.json

      - name: Install site dependencies
        run: npm ci
        working-directory: site

      - name: Build site
        run: npm run build
        working-directory: site

      - name: Deploy to Firebase Hosting
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KRONROE }}
          channelId: live
          projectId: kronroe

      - name: Install Playwright (Chromium)
        run: |
          npm install --no-save playwright@1.51.1
          npx playwright install --with-deps chromium
        working-directory: site

      - name: Run post-deploy smoke test
        env:
          PLAYGROUND_URL: ${{ steps.deploy.outputs.details_url }}
        run: |
          set -o pipefail
          URL="${PLAYGROUND_URL:-https://kronroe.web.app}"
          echo "Smoke testing ${URL}"
          node scripts/smoke-playground.mjs "${URL}" | tee smoke-result.json
          {
            echo "## Playground Smoke Test"
            echo ""
            echo "- URL: ${URL}"
            echo "- Workflow: `${{ github.workflow }}`"
            echo ""
            echo '```json'
            cat smoke-result.json
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
        working-directory: site
