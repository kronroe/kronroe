name: CLA Signatures Sync

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-cla-signatures:
    name: Sync cla-signatures with main
    runs-on: ubuntu-latest

    steps:
      - name: Ensure cla-signatures branch exists
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "cla-signatures";

            try {
              await github.rest.git.getRef({
                owner,
                repo,
                ref: `heads/${branch}`,
              });
              core.info(`${branch} already exists`);
            } catch (error) {
              if (error.status !== 404) throw error;

              const mainRef = await github.rest.git.getRef({
                owner,
                repo,
                ref: "heads/main",
              });

              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/heads/${branch}`,
                sha: mainRef.data.object.sha,
              });
              core.info(`Created ${branch} at ${mainRef.data.object.sha}`);
            }

      - name: Merge main into cla-signatures
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              const result = await github.rest.repos.merge({
                owner,
                repo,
                base: "cla-signatures",
                head: "main",
                commit_message: "chore(cla): sync cla-signatures with main",
              });
              if (result.status === 204) {
                core.info("cla-signatures already up to date");
                return;
              }
              core.info(`Merged via ${result.data.sha}`);
            } catch (error) {
              // Already up to date isn't a failure for this maintenance workflow.
              if (error.status === 204 || /up[- ]to[- ]date/i.test(error.message)) {
                core.info("cla-signatures already up to date");
                return;
              }
              throw error;
            }
